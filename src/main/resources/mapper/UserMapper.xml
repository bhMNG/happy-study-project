<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.happystudy.dao.UserMapper">
	<sql id="BASE_TABLE">
		t_user
	</sql>
	<sql id="BASE_COL">
		t_user.id, u_username, u_userpass, u_phone
	</sql>
	<!-- 修改密码 -->
	<update id="updateUser">
		update t_user
		set t_user.u_userpass=#{password}
		where t_user.u_username=#{username}
	</update>
	<!-- 修改用户个人信息 -->
	<!-- 
	<update id="updateUserInfo">
		update t_user_info
		set t_user_info.i_name=#{iName},
		t_user_info.i_sex=#{iSex},
		t_user_info.i_photo=#{iPhoto},
		t_user_info.i_address=#{iAddress},
		t_user_info.i_birthday=#{iBirthday},
		t_user_info.i_idcard=#{iIdcard}
		where t_user_info.i_username_fk=#{iUsernameFk}
	</update> -->
	<update id="updateUserInfo">
		update t_user_info set ${key} = #{value} where t_user_info.i_username_fk=#{username}
	</update>
	<!-- 查询已存在用户(5个参数) -->
	<select id="queryUser" resultType="map" parameterType="map">
		select t_user.*,r_property,r_name from t_user left join t_role on t_user.u_role_fk=t_role.r_property
		<if test="keyword !=''">where (t_user.u_phone like '%${keyword}%' or u_username like '%${keyword}')</if>
		order by ${orderBy} ${orderWay} limit ${offset},${pageSize}
	</select>
	<!-- 查询用户个人信息 -->
	<select id="queryUserInfo" resultType="com.happystudy.model.UserInfo">
		select i_name,i_sex,i_photo,i_address,i_birthday,i_idcard from t_user
		right join t_user_info on t_user.u_username=t_user_info.i_username_fk
		where t_user.u_username=#{username}
	</select>
	<!-- 查询用户角色名称 -->
	<select id="queryUserRole" resultType="com.happystudy.model.Role">
		select r_name, r_property from t_user
		left join t_role on t_user.u_role_fk=t_role.r_property
		where t_user.u_username=#{username}
	</select>
	<!-- 删除用户 -->
	<delete id="delUserByName">
		delete from t_user where u_username=#{username}
	</delete>
	<!-- 通过用户名查询用户信息 -->
	<select id="findUserByName" resultType="com.happystudy.model.User">
		select * from t_user
		where t_user.u_username=#{username}
	</select>
	<!-- 查询用户人数 -->
	<select id="queryUserCount" resultType="java.lang.Integer">
		select COUNT(id) from t_user
	</select>
	<!-- 查询用户权限职责信息 -->
	<select id="queryUserProp" resultType="com.happystudy.model.Property">
		select p_duty from t_user left join t_role on t_user.u_role_fk=t_role.id left join t_property on t_property.p_role_fk=t_role.id
		where u_username=#{username}
	</select>
	<!-- 查询用户职权名和权限值 -->
	<select id="queryUserPosition" resultType="map">
		select r_name, u_role_fk from t_user left join t_role on t_user.u_role_fk = t_role.r_property where u_username = #{username}
	</select>
	<!-- 添加用户 -->
	<insert id="addUser">
		insert into t_user (u_username, u_userpass, u_phone)
		values (#{uUsername},#{uUserpass},#{uPhone})
	</insert>
	<!-- 根据电话查找用户 -->
	<select id="findUserByPhone"  resultType="com.happystudy.model.User">
		select u_username,u_phone from t_user
		where u_phone=#{phonenum}		
	</select>
	<!-- 绑定手机 -->
	<update id="bindPhone">
		update  t_user set t_user.u_phone=#{phonenum} where u_username = #{username}
	</update>

    <!-- 查询课程状态 -->
    <select id="getCourseStatus" resultType="com.happystudy.model.Course">
		select co_status from t_teacher left join t_course on t_teacher.t_course_fk=t_course.co_no
		where t_no=#{tNo}
	</select>
    <!-- 修改课程状态 -->
    <update id="setCourseStatus">
		update t_course
		set t_course.co_status=#{status}
  		from t_teacher left join t_course on t_teacher.t_course_fk=t_course.co_no
		where co_no=#{coNo}
	</update>
    <!-- 查询教师是否选课 -->
    <select id="getTeacherCourseFk" resultType="String">
		select t_course_fk from t_teacher where t_no=#{tNo}
	</select>
    <!-- 修改教师课程状态 -->
    <update id="setTeacherCourseFk">
		update t_course
		set t_course.co_no=#{coNo}
		from t_teacher left join t_course on t_teacher.t_course_fk=t_course.co_no
		where t_no=#{tNo}
	</update>
	<!-- 查询老师用户的负责课程 -->
	<select id="queryTeacherUserCourse" resultType="map">
		select co_no, co_name, t_name from t_user left join t_teacher on t_user.u_username = t_teacher.t_user_fk 
		left join t_course ON t_teacher.t_course_fk = t_course.co_no 
		where u_username=#{username} and t_user.u_role_fk = 1 order by #{orderBy} #{orderWay}
	</select>
	<!-- 查询学生用户的已选课程 -->
	<select id="queryStudentUserCourse" resultType="map">
		select co_no, co_name, t_name from t_user inner join t_student on t_user.u_username = t_student.s_user_fk 
		inner JOIN t_depart on t_student.s_depart_fk = t_depart.d_no inner JOIN t_teacher on t_depart_fk = t_teacher.t_depart_fk
		inner JOIN t_course on t_teacher.t_course_fk = t_course.co_no = t_user.u_username 
		where u_username=#{username} and t_user.u_role_fk = 2 order by #{orderBy} #{orderWay}
	</select>
	<insert id="insertUserInfo">
		insert into t_user_info (${key}, i_username_fk)
		values (#{value},#{username})
	</insert>
</mapper>